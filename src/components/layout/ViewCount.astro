---
import { drizzle } from 'drizzle-orm/d1'
import { views } from 'src/schema'
import { sql } from 'drizzle-orm'
import abbreviate from 'src/utils/abbreviate'

const { path } = Astro.props

const db = drizzle(Astro.locals.runtime.env.DB)

const res = await db
  .insert(views)
  .values({
    path: path,
    count: 1
  })
  .onConflictDoUpdate({
    target: views.path,
    set: {
      count: sql`${views.count} + 1`
    }
  })
  .returning({
    count: views.count
  })
  .then((res) => res[0])
---

{res && abbreviate(res.count)} views
